<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title th:text="${recetaForm.id == null ? 'Nueva' : 'Editar'} + ' receta'">Receta</title>

    <!--  Bootstrap 5  --------------------------------------------------->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"/>

    <style>
        .table-head   {background:#8dc2ff;color:#fff;font-weight:bold}
        .table-body td{vertical-align:middle}
    </style>
</head>
<body class="container py-3">

<h2 th:text="${recetaForm.id == null ? 'Nueva receta' : 'Editar receta'}"></h2>

<form th:action="@{/recetas}" th:object="${recetaForm}" method="post" novalidate>

    <input type="hidden" th:field="*{id}" th:if="${recetaForm.id != null}"/>

    <div class="mb-3">
        <label class="form-label">Nombre de la receta</label>
        <input type="text" th:field="*{nombre}" class="form-control" required>
        <div th:errors="*{nombre}" class="text-danger small"></div>
    </div>

    <div class="mb-3">
        <label class="form-label">Descripción de la preparación</label>
        <textarea th:field="*{descripcion}" rows="3" class="form-control"></textarea>
        <div th:errors="*{descripcion}" class="text-danger small"></div>
    </div>

    <!-- ---------------- Tabla de ingredientes ------------------------- -->
    <fieldset class="border p-3 mb-3">
        <legend class="float-none w-auto px-2">Ingredientes</legend>

        <table id="tblIngredientes" class="table table-bordered">
            <thead>
            <tr class="table-head text-center">
                <th style="width:35%">Ingrediente</th>
                <th style="width:18%">Cantidad&nbsp;(kg)</th>
                <th style="width:18%">Calorías</th>
                <th style="width:10%"></th>
            </tr>
            </thead>

            <tbody class="table-body">

            <!---- EXISTENTES: se iteran al abrir en modo edición ---->
            <tr th:each="ing, stat : *{ingredientes}">
                <td>
                    <select th:name="|ingredientes[${stat.index}].ingredienteId|"
                            class="form-select" required>
                        <option value="" disabled>--Seleccione--</option>
                        <option th:each="opt : ${ingredientes}"
                                th:value="${opt.id}"
                                th:selected="${opt.id == ing.ingredienteId}"
                                th:text="${opt.nombre}"></option>
                    </select>
                </td>
                <td>
                    <input type="number" th:name="|ingredientes[${stat.index}].cantidad|"
                           th:value="${ing.cantidad}" min="0.01" step="0.01"
                           class="form-control text-end" required>
                </td>
                <td>
                    <input type="number" th:name="|ingredientes[${stat.index}].calorias|"
                           th:value="${ing.calorias}" min="0"
                           class="form-control text-end" required>
                </td>
                <td class="text-center">
                    <button type="button" class="btn btn-outline-danger btn-sm"
                            onclick="quitarFila(this)">&times;</button>
                </td>
            </tr>

            </tbody>
        </table>

        <button type="button" class="btn btn-primary" onclick="agregarFila()">Agregar ingrediente</button>
        <div th:errors="*{ingredientes}" class="text-danger small"></div>
    </fieldset>

    <!---- Errores globales, si los hay ---->
    <div th:if="${#fields.hasGlobalErrors()}" class="alert alert-danger">
        <p th:each="e : ${#fields.globalErrors()}" th:text="${e}"></p>
    </div>

    <button type="submit" class="btn btn-success">Guardar</button>
    <a th:href="@{/recetas}" class="btn btn-secondary">Cancelar</a>
</form>

<!-- ------------------------------------------------------------------- -->
<script th:inline="javascript">
    /*<![CDATA[*/
    //----- Lista de ingredientes enviada por el controlador -----------------
    const INGREDIENTES = [[${ingredientes}]];   // [{id:1,nombre:'Harina'}, …]

    // Devuelve la lista de <option> (selecciona el id pasado)
    function optionList(selectedId){
        return INGREDIENTES.map(i =>
            `<option value="${i.id}" ${i.id===selectedId?'selected':''}>${i.nombre}</option>`
        ).join('');
    }

    function agregarFila(){
        const tbody = document.querySelector('#tblIngredientes tbody');
        const idx   = tbody.children.length;
        const tr    = document.createElement('tr');
        tr.innerHTML = `
        <td>
            <select name="ingredientes[${idx}].ingredienteId" class="form-select" required>
                <option value="" disabled selected>--Seleccione--</option>
                ${optionList()}
            </select>
        </td>
        <td>
            <input type="number" name="ingredientes[${idx}].cantidad"
                   min="0.01" step="0.01" required
                   class="form-control text-end">
        </td>
        <td>
            <input type="number" name="ingredientes[${idx}].calorias"
                   min="0" required
                   class="form-control text-end">
        </td>
        <td class="text-center">
            <button type="button" class="btn btn-outline-danger btn-sm"
                    onclick="quitarFila(this)">&times;</button>
        </td>`;
        tbody.appendChild(tr);
    }

    function quitarFila(btn){
        const row = btn.closest('tr');
        row.remove();                             // 1. elimina
        // 2. re-indiza todos los name="ingredientes[i]..."
        document.querySelectorAll('#tblIngredientes tbody tr')
            .forEach((tr,i)=>{
                tr.querySelectorAll('select,input').forEach(el=>{
                    el.name = el.name.replace(/\d+/, i);
                });
            });
    }
    /*]]>*/
</script>

</body>
</html>
